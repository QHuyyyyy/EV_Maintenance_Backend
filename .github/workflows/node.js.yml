name: CI Pipeline


on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  test-and-build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Type check
      run: npx tsc --noEmit

    - name: Generate Swagger docs
      run: npm run swagger

    - name: Build project
      run: npm run build:prod

    - name: Run tests
      run: npm test

    - name: Check for build artifacts
      run: |
        if [ ! -d "dist" ]; then
          echo "Build failed: dist directory not found"
          exit 1
        fi
        if [ ! -f "dist/src/app.js" ]; then
          echo "Build failed: main app file not found"
          exit 1
        fi
        echo "Build successful: all artifacts generated"

  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Check package.json format
      run: |
        if ! jq . package.json > /dev/null; then
          echo "package.json is not valid JSON"
          exit 1
        fi

    - name: Verify TypeScript configuration
      run: |
        if ! npx tsc --showConfig > /dev/null; then
          echo "TypeScript configuration is invalid"
          exit 1
        fi

  heroku-compatibility:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Verify Procfile exists
      run: |
        if [ ! -f "Procfile" ]; then
          echo "Warning: Procfile not found"
          exit 1
        fi
        echo "Procfile found and validated"

    - name: Check start script
      run: |
        if [ ! -f "dist/src/app.js" ]; then
          echo "Start script target not found after build"
          exit 1
        fi
        echo "Start script target exists"